= RMU API Attack

REST API for attack management in the RMU system using MongoDB and Hexagonal Architecture.

== Description

This API exposes endpoints to manage attack information, including creating, querying, updating, and deleting attacks in the RMU (Role Master Unified) system. The API uses MongoDB for persistent data storage and follows Hexagonal Architecture (Ports and Adapters) principles for better separation of concerns, testability, and maintainability.

== Architecture

=== Hexagonal Architecture

The project follows Hexagonal Architecture principles with clear separation between:

* **Domain Layer** (`app/domain/`): Contains business logic, entities, and domain services
** `entities/`: Domain entities like `Attack`, `AttackInput`, etc.
** `ports/`: Interfaces (contracts) for external dependencies
** `services/`: Domain services containing business rules

* **Application Layer** (`app/application/`): Contains use cases that orchestrate domain operations
** `use_cases/`: Application-specific business logic and workflows

* **Infrastructure Layer** (`app/infrastructure/`): Contains adapters for external concerns
** `adapters/persistence/`: Database adapters (MongoDB implementation)
** `adapters/web/`: Web adapters (FastAPI controllers and DTOs)
** `dependency_container.py`: Dependency injection container

=== Benefits of This Architecture

* **Independence**: Business logic is independent of external frameworks
* **Testability**: Easy to unit test domain logic in isolation
* **Flexibility**: Easy to swap adapters (e.g., change from MongoDB to PostgreSQL)
* **Maintainability**: Clear separation of concerns makes code easier to maintain

== Prerequisites

* Python 3.11+
* MongoDB (local or remote instance)
* pip

== Installation

. Clone the repository and navigate to the project directory

. Install dependencies:
+
[source,bash]
----
pip install -r requirements.txt
----

. Configure environment variables (optional):
+
Copy `.env.example` to `.env` and modify as needed:
+
[source,bash]
----
cp .env.example .env
----

. Initialize the database with sample data (optional):
+
[source,bash]
----
python init_db.py
----

. Run the application:
+
[source,bash]
----
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
----

== Configuration

The application can be configured using environment variables:

* `MONGODB_URL`: MongoDB connection string (default: `mongodb://localhost:27017`)
* `MONGODB_DATABASE`: Database name (default: `rmu_attacks`)
* `DEBUG`: Enable debug mode (default: `false`)

== Endpoints

=== Attack Management

* `GET /v1/attacks/{attackId}` - Get details of a specific attack
* `POST /v1/attacks/` - Create a new attack
* `PATCH /v1/attacks/{attackId}` - Partially update an attack
* `DELETE /v1/attacks/{attackId}` - Delete an attack
* `GET /v1/attacks/` - List attacks with optional filtering

=== System Endpoints

* `GET /` - Root endpoint with API information
* `GET /health` - Health check endpoint with database connectivity status

== API Features

=== PATCH Operation

* **PATCH**: Partial updates - only provided fields are updated, others remain unchanged. This allows for efficient updates where you only need to modify specific attributes of an attack without affecting the rest of the data.

=== Query Parameters for Listing

When using `GET /v1/attacks/`, you can filter results:

* `tactical_game_id`: Filter by tactical game ID
* `status`: Filter by attack status
* `limit`: Maximum number of results (1-1000, default: 100)
* `skip`: Number of results to skip for pagination (default: 0)

== Documentation

Once the application is running, you can access the interactive documentation at:

* Swagger UI: http://localhost:8000/docs
* ReDoc: http://localhost:8000/redoc

== Development

=== Running Tests

[source,bash]
----
pytest
----

=== Using VS Code Tasks

The project includes VS Code tasks for common operations:

* **Start API Server**: Starts the development server
* **Run Tests**: Executes the test suite
* **Install Dependencies**: Installs Python dependencies

== Database Schema

The MongoDB collection `attacks` stores documents with the following structure:

[source,json]
----
{
  "id": "atk_001",
  "tacticalGameId": "game_001",
  "status": "executed",
  "input": {
    "sourceId": "source_001",
    "targetId": "target_001",
    "actionPoints": 3,
    "mode": "mainHand"
  },
  "roll": {
    "roll": 15
  },
  "results": {
    "labelResult": "8AT",
    "hitPoints": 8,
    "criticals": [
      {
        "id": "crit_001",
        "status": "applied"
      }
    ]
  }
}
----

== Error Handling

The API returns appropriate HTTP status codes:

* `200` - Success
* `201` - Created
* `204` - No Content (for successful deletions)
* `400` - Bad Request
* `404` - Not Found
* `409` - Conflict (duplicate ID)

== Technology Stack

* **FastAPI**: Modern Python web framework
* **MongoDB**: NoSQL database via Motor (async driver)
* **Pydantic**: Data validation and serialization
* **Uvicorn**: ASGI server
* **Pytest**: Testing framework
* **Hexagonal Architecture**: Clean architecture with ports and adapters pattern

== Project Structure

[source,tree]
----
app/
├── domain/                     # Domain layer (business logic)
│   ├── entities/              # Domain entities
│   │   ├── __init__.py
│   │   └── attack.py          # Attack entity
│   ├── ports/                 # Interfaces/contracts
│   │   ├── __init__.py
│   │   └── attack_ports.py    # Repository and service interfaces
│   ├── services/              # Domain services
│   │   ├── __init__.py
│   │   └── attack_domain_service.py
│   └── __init__.py
├── application/               # Application layer (use cases)
│   ├── use_cases/             # Business workflows
│   │   ├── __init__.py
│   │   └── attack_use_cases.py
│   └── __init__.py
├── infrastructure/            # Infrastructure layer (adapters)
│   ├── adapters/
│   │   ├── persistence/       # Database adapters
│   │   │   ├── __init__.py
│   │   │   └── mongo_attack_repository.py
│   │   ├── web/               # Web adapters
│   │   │   ├── __init__.py
│   │   │   ├── attack_controller.py
│   │   │   └── attack_dtos.py
│   │   └── __init__.py
│   ├── dependency_container.py # Dependency injection
│   └── __init__.py
├── config.py                  # Configuration
├── main.py                    # FastAPI application setup
└── __init__.py
----

